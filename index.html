<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Comparateur RIASEC</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; color:#222; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    h1 { font-size:1.2rem; margin:0; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .scales { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .scale {
      border:1px solid #ddd; padding:10px; border-radius:8px; background:#fafafa;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .scale h4 { margin:0 8px 0 0; font-size:0.95rem; }
    label { font-size:0.9rem; }
    input[type="text"], input[type="number"] {
      padding:6px 8px; border:1px solid #ccc; border-radius:6px; font-size:0.9rem;
    }
    .scores { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .scores input { width:70px; }
    .invalid { border-color:#d93025; background:#ffecec; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
    .btn-primary { background:#2b6cb0; color:white; }
    .btn-ghost { background:#fff; border:1px solid #ccc; color:#222; }
    .btn-danger { background:#d9534f; color:white; }
    .btn-success { background:#28a745; color:white; }
    .btn-info { background:#17a2b8; color:white; }
    #chart-wrap {
      max-width:1200px;
      margin:18px auto;
      padding: 0 20px;
      box-sizing: border-box;
    }
    #riasecChart {
      width:100% !important;
      height:600px !important;
      display:block;
      max-height: 70vh;
      min-height: 400px;
    }
    #summary { text-align:left; margin-top:12px; font-weight:400; white-space:pre-wrap; line-height:1.4; font-size:0.95rem; }
    .small { font-weight:400; font-size:0.9rem; color:#444; margin-top:6px; }
    .note { font-size:0.9rem; color:#333; margin-top:8px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .prediger { font-size:0.9rem; color:#333; margin-top:8px;}
    /* Tablettes et petits √©crans */
    @media (max-width: 1024px) {
      #chart-wrap {
        max-width: 100%;
        padding: 0 15px;
      }
      #riasecChart {
        height: 500px !important;
        max-height: 60vh;
      }
    }

    /* Grands t√©l√©phones */
    @media (max-width: 768px) {
      #chart-wrap {
        padding: 0 10px;
      }
      #riasecChart {
        height: 450px !important;
        max-height: 55vh;
        min-height: 350px;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .btn {
        width: 100%;
        text-align: center;
      }
    }

    /* Petits t√©l√©phones */
    @media (max-width: 520px) {
      .scores input { width:56px; }
      input[type="text"], input[type="number"] { width:100%; }
      .scale { flex-direction:column; align-items:stretch; }
      #chart-wrap {
        padding: 0 5px;
      }
      #riasecChart {
        height: 400px !important;
        max-height: 50vh;
        min-height: 300px;
      }
      body {
        margin: 10px;
      }
      h1 {
        font-size: 1.1rem;
      }
    }

    /* Tr√®s petits √©crans */
    @media (max-width: 360px) {
      #riasecChart {
        height: 350px !important;
        min-height: 280px;
      }
      .btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Comparateur RIASEC ‚Äî multi-√©chelles + Prediger</h1>
    <div class="controls">
      <button id="addScaleBtn" class="btn btn-primary">+ Ajouter une √©chelle</button>
      <button id="plotBtn" class="btn btn-primary">Afficher le graphique</button>
      <button id="resetBtn" class="btn btn-ghost">R√©initialiser</button>
    </div>
    <div class="controls">
      <button id="saveBtn" class="btn btn-success">üíæ Sauvegarder la session</button>
      <button id="loadBtn" class="btn btn-info">üìÇ Charger une session</button>
    </div>
  </header>

  <main>
    <div class="small">Ajoute des √©chelles, renseigne nom, √©tendue et scores R,I,A,S,E,C. Coche un ou plusieurs √©l√©ments pour les afficher. Pour la lisibilit√©, √©viter d'afficher trop de courbes simultan√©ment.</div>

    <div id="scalesContainer" class="scales"></div>

    <div id="chart-wrap">
      <canvas id="riasecChart"></canvas>
      <div id="summary" aria-live="polite"></div>

      <ul class="note" id="footnote">
        <strong>La diff√©rentiation </strong>est calcul√©e via la technique du Pr Vignaud et avec les √©talonnages du RIASEC Flash 2 du Fabien Beltrame <a href="http://deporientation.free.fr/Ressources/Manuel_RIASECFlash2_V3.1.pdf" target="_blank">r√©f√©rence page 17</a>
      </ul>

      <div class="note" id="diff-interpretation">
        <strong>Interpr√©tation de la diff√©renciation</strong> : un indice de diff√©renciation √©talonn√© en classe IV indique un profil RIASEC moyennement diff√©renci√© ; en classe I, II ou III le profil est faiblement diff√©renci√© ; en classe V, VI ou VII le profil est fortement diff√©renci√©.
      </div>

      <div class="prediger" id="prediger-note">
        Les <strong>dimensions de Prediger</strong> (calcul√©es avec la m√©thode de <a href="https://www.researchgate.net/publication/232418263_Adherence_to_RIASEC_Structure_as_a_Key_Career_Decision_Construct" target="_blank">Tracey</a>) sont : <em>Objets vs Personnes</em> et <em>Faits vs Id√©es</em>.
      </div>

      <div class="note" id="kendall-note">
        <strong>Analyse de concordance (Kendall W)</strong> : Le coefficient W mesure l'accord entre plusieurs √©chelles RIASEC sur le classement des types. W varie de 0 (aucune concordance) √† 1 (concordance parfaite). Le test de significativit√© indique si l'accord observ√© est statistiquement fiable.
      </div>
    </div>
  </main>

  <script>
    // =================================================================================
    // CONSTANTES ET VARIABLES GLOBALES
    // =================================================================================
    // Labels RIASEC dans l'ordre standard
    const LABELS = ['R','I','A','S','E','C'];
    // Compteur pour g√©n√©rer des IDs uniques pour chaque √©chelle
    let scaleIdCounter = 0;
    // Stockage de toutes les √©chelles cr√©√©es
    // Structure: {id, name, max, values:[6], selected}
    let scales = [];

    // =================================================================================
    // PALETTE DE COULEURS POUR LES GRAPHES
    // =================================================================================
    // Palette de 8 couleurs distinctes pour diff√©rencier les √©chelles sur le graphique
    const BASE_COLORS = [
      'rgba(220,53,69,1)',    // Rouge
      'rgba(13,110,253,1)',   // Bleu
      'rgba(40,167,69,1)',    // Vert
      'rgba(255,193,7,1)',    // Jaune
      'rgba(102,16,242,1)',   // Violet
      'rgba(23,162,184,1)',   // Cyan
      'rgba(255,87,34,1)',    // Orange
      'rgba(0,123,255,1)'     // Bleu secondaire
    ];

    // =================================================================================
    // GESTION DES COULEURS POUR LES GRAPHES
    // =================================================================================
    /**
     * G√©n√®re une paire de couleurs (bordure + fond) pour une √©chelle donn√©e
     * @param {number} i - Index de l'√©chelle (0, 1, 2, etc.)
     * @returns {object} Objet avec border (opaque) et background (translucide)
     */
    function colorForIndex(i) {
      // S√©lectionne une couleur de base en bouclant sur la palette
      const base = BASE_COLORS[i % BASE_COLORS.length];
      // Cr√©e une version translucide pour le fond (remplace opacity 1 par 0.18)
      const bg = base.replace(/1\)$/, '0.18)');
      return { border: base, background: bg };
    }

    // =================================================================================
    // INITIALISATION DE L'APPLICATION
    // =================================================================================
    /**
     * √âv√©nement d√©clench√© quand le DOM est compl√®tement charg√©
     * Cr√©e automatiquement deux √©chelles d'exemple au d√©marrage
     */
    window.addEventListener('DOMContentLoaded', () => {
      // Ajoute une √©chelle d'auto√©valuation (notation 1-5)
      addScale('Auto√©valuation', 5, [0,0,0,0,0,0]);
      // Ajoute une √©chelle de test en ligne (notation 0-100)
      addScale('Test en ligne', 100, [0,0,0,0,0,0]);
    });

    // =================================================================================
    // GESTION DES √âCHELLES RIASEC
    // =================================================================================
    /**
     * Cr√©e une nouvelle √©chelle RIASEC avec ses contr√¥les HTML associ√©s
     * @param {string} name - Nom de l'√©chelle (ex: "Auto√©valuation", "Test professionnel")
     * @param {number} max - Valeur maximale possible (ex: 5 pour une √©chelle 1-5, 100 pour un test)
     * @param {number[]} values - Scores RIASEC [R, I, A, S, E, C]
     */
    function addScale(name='√âchelle', max=5, values=[0,0,0,0,0,0]) {
      const id = ++scaleIdCounter;
      const s = { id, name, max, values: values.slice(), selected: false };
      scales.push(s);

      const container = document.getElementById('scalesContainer');
      const el = document.createElement('div');
      el.className = 'scale';
      el.id = `scale-${id}`;
      el.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="select-${id}" aria-label="S√©lection ${id}">
        </div>
        <div style="flex:1;min-width:220px;">
          <div class="row">
            <h4>√âchelle</h4>
            <input type="text" id="name-${id}" value="${escapeHtml(name)}" style="min-width:160px;">
            <label>√âtendue max</label>
            <input type="number" id="max-${id}" value="${max}" min="1" step="any" style="width:85px;">
            <button class="btn btn-danger" id="del-${id}" title="Supprimer">Suppr</button>
          </div>
          <div class="scores" id="scores-${id}">
            ${LABELS.map((L,i)=>`<label>${L}: <input type="number" id="val-${id}-${L}" value="${values[i]}" step="any"></label>`).join('')}
          </div>
        </div>
      `;
      container.appendChild(el);

      document.getElementById(`del-${id}`).addEventListener('click', ()=> removeScale(id));
      document.getElementById(`select-${id}`).addEventListener('change', (e)=> toggleSelect(id, e.target.checked));
      document.getElementById(`name-${id}`).addEventListener('input', (e)=> updateScaleMeta(id,'name', e.target.value));
      document.getElementById(`max-${id}`).addEventListener('input', (e)=> updateScaleMeta(id,'max', parseFloat(e.target.value)));
      LABELS.forEach(L => {
        document.getElementById(`val-${id}-${L}`).addEventListener('input', (e)=> updateScaleValue(id, L, e.target.value));
      });
    }

    function removeScale(id) {
      scales = scales.filter(s=>s.id!==id);
      const el = document.getElementById(`scale-${id}`); if (el) el.remove();
      updateEmptyIfNeeded();
    }

    function updateScaleMeta(id, prop, val) {
      const s = scales.find(x=>x.id===id); if (!s) return;
      if (prop === 'max') s.max = (isNaN(val) || val <= 0) ? 1 : val;
      else s.name = String(val || '');
    }

    function updateScaleValue(id, label, raw) {
      const s = scales.find(x=>x.id===id); if (!s) return;
      const idx = LABELS.indexOf(label);
      const v = parseFloat(raw);
      s.values[idx] = raw === '' ? '' : (isNaN(v) ? '' : v);
      const input = document.getElementById(`val-${id}-${label}`);
      if (raw === '' || isNaN(v) || v < 0 || v > s.max) input.classList.add('invalid');
      else input.classList.remove('invalid');
    }

    function toggleSelect(id, checked) {
      const s = scales.find(x=>x.id===id); if (!s) return;
      s.selected = checked;
    }

    document.getElementById('addScaleBtn').addEventListener('click', ()=> {
      addScale('Nouvelle √©chelle', 5, [0,0,0,0,0,0]);
      const last = document.getElementById(`scale-${scaleIdCounter}`);
      if (last) last.scrollIntoView({ behavior:'smooth', block:'center' });
    });

    document.getElementById('resetBtn').addEventListener('click', ()=> {
      scales = []; scaleIdCounter = 0;
      document.getElementById('scalesContainer').innerHTML = '';
      document.getElementById('summary').innerHTML = '';
      if (window.myChart) { window.myChart.destroy(); window.myChart = null; }
      addScale('Auto√©valuation', 5, [0,0,0,0,0,0]);
      addScale('Test en ligne', 100, [0,0,0,0,0,0]);
    });

    function validateScale(s) {
      for (let i=0;i<6;i++) {
        const raw = s.values[i];
        const v = parseFloat(raw);
        if (raw === '' || isNaN(v) || v < 0 || v > s.max) return false;
      }
      return true;
    }

    // =================================================================================
    // FONCTIONS DE CALCUL ET DE NORMALISATION
    // =================================================================================

    /**
     * Calcule le coefficient de concordance de Kendall (W)
     * Mesure l'accord entre plusieurs √©chelles sur les scores RIASEC
     * @param {object[]} scales - Tableau d'√©chelles s√©lectionn√©es avec scores valides
     * @returns {object} Objet contenant W, chi2, df, p-value et interpr√©tation
     */
    function computeKendallW(scales) {
      if (scales.length < 2) {
        return { W: null, chi2: null, df: null, p: null, interpretation: "Besoin d'au moins 2 √©chelles pour calculer la concordance" };
      }

      const n = scales.length; // nombre d'√©chelles (juges)
      const m = 6; // nombre de types RIASEC (√©l√©ments √† √©valuer)

      // Convertit les scores en rangs pour chaque √©chelle
      const ranks = scales.map(scale => {
        // Pour chaque √©chelle, classe les scores RIASEC par ordre d√©croissant
        const scores = scale.values.map(v => parseFloat(v));
        const sortedIndices = scores.map((score, index) => ({ score, index }))
                                  .sort((a, b) => b.score - a.score)
                                  .map(item => item.index);

        // Attribue les rangs (1 = plus haut score, 6 = plus bas score)
        const rank = new Array(6).fill(0);
        sortedIndices.forEach((idx, position) => {
          rank[idx] = position + 1; // rang de 1 √† 6
        });

        return rank;
      });

      // Calcule la somme des rangs pour chaque type RIASEC
      const sumRanks = new Array(m).fill(0);
      for (let j = 0; j < m; j++) {
        for (let i = 0; i < n; i++) {
          sumRanks[j] += ranks[i][j];
        }
      }

      // Calcule la moyenne des rangs
      const meanRank = sumRanks.reduce((sum, r) => sum + r, 0) / m;

      // Calcule la somme des carr√©s des √©carts √† la moyenne
      let sumSquaredDeviations = 0;
      for (let j = 0; j < m; j++) {
        const deviation = sumRanks[j] - meanRank;
        sumSquaredDeviations += deviation * deviation;
      }

      // Calcule le coefficient W
      const numerator = 12 * sumSquaredDeviations;
      const denominator = n * n * (m * m * m - m);
      const W = numerator / denominator;

      // Test de significativit√© (Khi-deux)
      const chi2 = (n * (m - 1) * W);
      const df = m - 1;

      // Calcule le p-value approximatif
      let p = null;
      if (chi2 > 0 && df > 0) {
        // Approximation du khi-deux avec df degr√©s de libert√©
        p = chiSquarePValue(chi2, df);
      }

      // Interpr√©tation du r√©sultat
      let interpretation = "";
      if (W === null) {
        interpretation = "Impossible de calculer le coefficient";
      } else if (W < 0.1) {
        interpretation = "Concordance tr√®s faible - Les √©chelles divergent consid√©rablement";
      } else if (W < 0.3) {
        interpretation = "Concordance faible - Divergences notables entre les √©chelles";
      } else if (W < 0.5) {
        interpretation = "Concordance mod√©r√©e - Accord partiel entre les √©chelles";
      } else if (W < 0.7) {
        interpretation = "Bonne concordance - Accord satisfaisant entre les √©chelles";
      } else if (W < 0.9) {
        interpretation = "Forte concordance - Tr√®s bon accord entre les √©chelles";
      } else {
        interpretation = "Concordance excellente - Accord quasi parfait entre les √©chelles";
      }

      // Ajoute l'interpr√©tation de la significativit√©
      if (p !== null) {
        if (p < 0.001) {
          interpretation += `\nLa concordance est hautement significative (p < 0.001)`;
        } else if (p < 0.01) {
          interpretation += `\nLa concordance est tr√®s significative (p < 0.01)`;
        } else if (p < 0.05) {
          interpretation += `\nLa concordance est significative (p < 0.05)`;
        } else {
          interpretation += `\nLa concordance n'est pas significative (p = ${p.toFixed(3)})`;
        }
      }

      return {
        W: Math.round(W * 1000) / 1000, // arrondi √† 3 d√©cimales
        chi2: Math.round(chi2 * 100) / 100,
        df: df,
        p: p,
        interpretation: interpretation
      };
    }

    /**
     * Calcule approximativement la p-value pour un test du khi-deux
     * @param {number} chi2 - Valeur du khi-deux
     * @param {number} df - Degr√©s de libert√©
     * @returns {number} p-value approximative
     */
    function chiSquarePValue(chi2, df) {
      // Approximation grossi√®re pour les besoins de cette application
      // Dans un contexte r√©el, utiliser une biblioth√®que statistique

      // Table de valeurs critiques approximatives pour diff√©rents df
      const criticalValues = {
        1: [3.84, 6.63, 10.83],    // p=0.05, 0.01, 0.001
        2: [5.99, 9.21, 13.82],
        3: [7.81, 11.34, 16.27],
        4: [9.49, 13.28, 18.47],
        5: [11.07, 15.09, 20.52],
        6: [12.59, 16.81, 22.46],
        7: [14.07, 18.48, 24.32],
        8: [15.51, 20.09, 26.12],
        9: [16.92, 21.67, 27.88],
        10: [18.31, 23.21, 29.59]
      };

      const crit = criticalValues[df] || criticalValues[10];

      if (chi2 < crit[0]) return Math.max(0.05, 0.5 / Math.pow(chi2 + 1, 0.5));
      if (chi2 < crit[1]) return Math.max(0.01, 0.05 / Math.pow(chi2 + 1, 0.3));
      if (chi2 < crit[2]) return Math.max(0.001, 0.01 / Math.pow(chi2 + 1, 0.2));
      return 0.001; // Tr√®s significative
    }
    /**
     * Normalise une valeur pour l'affichage sur le graphique radar (√©chelle 0-5)
     * @param {number} value - Valeur brute √† normaliser
     * @param {number} max - Valeur maximale possible pour cette √©chelle
     * @returns {number} Valeur normalis√©e entre 0 et 5
     */
    function normalizeForChart(value, max) {
      if (max <= 0) return 0;
      // Formule: (valeur / max) * 5, arrondi √† 1 d√©cimale
      return Math.round((value / max) * 5 * 10) / 10;
    }

    /**
     * Convertit une valeur en pourcentage (0-100%)
     * @param {number} value - Valeur √† convertir
     * @param {number} max - Valeur maximale de r√©f√©rence
     * @returns {number} Pourcentage arrondi
     */
    function toPercent100(value, max) {
      if (max <= 0) return 0;
      return (value / max) * 100;
    }

    /**
     * Identifie les deux types RIASEC dominants dans un profil
     * @param {number[]} scores - Scores RIASEC normalis√©s [R, I, A, S, E, C]
     * @returns {string[]} Les deux types principaux tri√©s par score d√©croissant
     */
    function getTopTwoTypes(scores) {
      // Associe chaque type √† son score
      const paired = LABELS.map((lab,i)=>({ type:lab, score:scores[i] }));
      // Trie par score d√©croissant
      paired.sort((a,b)=> b.score - a.score);
      return [paired[0].type, paired[1].type];
    }

    // =================================================================================
    // ANALYSE DE LA CONSISTANCE ENTRE TYPES RIASEC
    // =================================================================================
    /**
     * √âvalue la coh√©rence entre les deux types RIASEC dominants
     * Utilise la structure hexagonale RIASEC pour mesurer la proximit√©
     * @param {string} type1 - Premier type dominant (ex: "R", "I", "A", etc.)
     * @param {string} type2 - Deuxi√®me type dominant
     * @returns {string} Niveau de consistance: "Forte", "Moyenne" ou "Faible"
     */
    function evaluateConsistance(type1, type2) {
      // Structure hexagonale RIASEC dans l'ordre
      const hex = ['R','I','A','S','E','C'];
      // Trouve les positions des deux types dans l'hexagone
      const i1 = hex.indexOf(type1), i2 = hex.indexOf(type2);
      // Calcule la distance la plus courte (min entre sens horaire et anti-horaire)
      const d = Math.min(Math.abs(i1-i2), 6 - Math.abs(i1-i2));
      // Interpr√©tation selon la proximit√©:
      if (d === 1) return 'Forte';      // Types adjacents (R-I, I-A, etc.)
      if (d === 2) return 'Moyenne';    // Types espac√©s d'un intervalle
      return 'Faible';                  // Types oppos√©s ou tr√®s √©loign√©s
    }

    // =================================================================================
    // CALCUL DE L'INDICE DE DIFF√âRENTIATION RIASEC
    // =================================================================================
    /**
     * Calcule l'indice de diff√©rentiation selon la m√©thode de Pr Vignaud
     * Formule: D = (t1 - (t2 + t3)/2) + (t3 - (t4 + t5)/2)
     * o√π t1 √† t5 sont les 5 premiers scores tri√©s par ordre d√©croissant
     * @param {number[]} values - Scores RIASEC bruts [R, I, A, S, E, C]
     * @param {number} max - Valeur maximale possible pour cette √©chelle
     * @returns {number} Indice D arrondi √† 2 d√©cimales (√©chelle 0-24 max)
     */
    function computeDifferentiationIndex_on100(values, max) {
      // Convertit les scores selon l'√©talonnage RIASEC (max 24, pas 100)
      const normalized = values.map(v => (parseFloat(v) / max) * 24);
      // Trie les scores normalis√©s par ordre d√©croissant
      const s = normalized.slice().sort((a,b)=> b - a);
      // Extrait les 5 premiers scores (avec valeur par d√©faut 0 si undefined)
      const t1 = s[0] || 0, t2 = s[1] || 0, t3 = s[2] || 0, t4 = s[3] || 0, t5 = s[4] || 0;
      // Applique la formule de diff√©rentiation
      const D = (t1 - (t2 + t3)/2) + (t3 - (t4 + t5)/2);
      return Math.round(D * 100) / 100;
    }

    // =================================================================================
    // CLASSIFICATION DE LA DIFF√âRENTIATION PAR SEXE
    // =================================================================================
    /**
     * Classe l'indice de diff√©rentiation selon les normes √©tablies
     * Utilise des bar√®mes diff√©rents pour hommes et femmes selon RIASEC Flash 2
     * @param {number} D - Indice de diff√©rentiation calcul√© (√©chelle 0-24)
     * @returns {object} Objet avec les classes pour homme et femme
     */
    function classifyDifferentiation(D) {
      // D√©finition des classes avec intervalles sp√©cifiques homme/femme (RIASEC Flash 2)
      const classes = [
        { name:'I', homme:[0,2], femme:[0,2] },
        { name:'II', homme:[3,4], femme:[3,4] },
        { name:'III', homme:[5,6], femme:[5,8] },
        { name:'IV', homme:[7,8], femme:[9,10] },
        { name:'V', homme:[9,12], femme:[11,13] },
        { name:'VI', homme:[13,15], femme:[14,16] },
        { name:'VII', homme:[16,24], femme:[17,24] }
      ];

      /**
       * Trouve la classe correspondant √† un indice D pour un sexe donn√©
       * @param {number} D - Indice de diff√©rentiation
       * @param {string} sex - 'homme' ou 'femme'
       * @returns {string} Nom de la classe (I √† VII)
       */
      const findClass = (D, sex) => {
        for (let c of classes) {
          const r = sex === 'homme' ? c.homme : c.femme;
          if (D >= r[0] && D <= r[1]) return c.name;
        }
        return 'VII'; // Classe maximale par d√©faut
      };
      return { homme: findClass(D,'homme'), femme: findClass(D,'femme') };
    }

    /**
     * Convertit une classe de diff√©rentiation en niveau interpr√©table
     * @param {string} clsName - Nom de la classe (I, II, III, etc.)
     * @returns {string} Niveau de diff√©rentiation: "Faible", "Moyenne" ou "Forte"
     */
    function differentiationLevelFromClass(clsName) {
      if (['I','II','III'].includes(clsName)) return 'Faible';
      if (clsName === 'IV') return 'Moyenne';
      return 'Forte';
    }

    // =================================================================================
    // CALCUL DES DIMENSIONS DE PREDIGER/TRACEY
    // =================================================================================
    /**
     * Calcule les dimensions de Prediger selon la m√©thode de Tracey
     * Ces dimensions orthogonales aux types RIASEC permettent une analyse compl√©mentaire
     * @param {number[]} values - Scores RIASEC bruts [R, I, A, S, E, C]
     * @param {number} max - Valeur maximale possible pour cette √©chelle
     * @returns {object} Objet avec things_people et ideas_data
     *
     * Formules:
     * - Things/People = (2*R + I - A - 2*S - E + C)
     * - Ideas/Data = (1.73*I + 1.73*A - 1.73*E - 1.73*C)
     */
    function computePredigerOn100(values, max) {
      // Convertit les scores bruts en pourcentages
      const pct = values.map(v => toPercent100(parseFloat(v), max));

      // Mappe les valeurs selon l'ordre RIASEC standard
      const R = pct[0] || 0, I = pct[1] || 0, A = pct[2] || 0,
            S = pct[3] || 0, E = pct[4] || 0, C = pct[5] || 0;

      // Applique les formules de Prediger/Tracey
      const things_people = (2*R + I - A - 2*S - E + C);
      const ideas_data = (1.73*I + 1.73*A - 1.73*E - 1.73*C);

      // Retourne les valeurs arrondies √† 2 d√©cimales
      return {
        things_people: Math.round(things_people * 100) / 100,
        ideas_data: Math.round(ideas_data * 100) / 100
      };
    }

    // =================================================================================
    // VISUALISATION GRAPHIQUE AVEC CHART.JS
    // =================================================================================
    /**
     * Cr√©e et affiche le graphique radar RIASEC avec plusieurs √©chelles
     * @param {number[][]} datasets - Tableau de datasets (chaque dataset = [R,I,A,S,E,C] normalis√©s)
     * @param {string[]} labelsForDatasets - Noms des √©chelles pour la l√©gende
     */
    function renderChart(datasets, labelsForDatasets) {
      // Pr√©pare les donn√©es pour Chart.js
      const data = {
        // Labels des axes (types RIASEC)
        labels: LABELS,
        // Chaque √©chelle devient un dataset avec ses propres couleurs
        datasets: datasets.map((d,i) => {
          const col = colorForIndex(i);
          return {
            label: labelsForDatasets[i],
            data: d,
            borderColor: col.border,
            backgroundColor: col.background,
            pointBackgroundColor: col.border,
            fill: true
          };
        })
      };

      // Configuration du graphique radar
      const config = {
        type: 'radar',
        data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          },
          scales: {
            r: {
              min: 0,
              max: 5,
              ticks: {
                stepSize: 1,
                font: { size: 11 },
                callback: function(value) {
                  return value.toString();
                }
              },
              pointLabels: {
                font: { size: 13, weight: 'bold' },
                color: '#333',
                callback: function(label) {
                  return label;
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                lineWidth: 1
              },
              angleLines: {
                color: 'rgba(0, 0, 0, 0.1)',
                lineWidth: 1
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Profil RIASEC (normalis√© 1‚Äì5)',
              font: { size: 16, weight: 'bold' },
              padding: 20
            },
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20,
                font: { size: 12 },
                generateLabels: function(chart) {
                  return chart.data.datasets.map((dataset, i) => ({
                    text: dataset.label,
                    fillStyle: dataset.backgroundColor,
                    strokeStyle: dataset.borderColor,
                    lineWidth: 2,
                    index: i
                  }));
                }
              }
            }
          },
          elements: {
            point: {
              radius: 6,
              hoverRadius: 8
            },
            line: {
              borderWidth: 3
            }
          }
        }
      };

      // R√©cup√®re le canvas et cr√©e/d√©truit le graphique
      const ctx = document.getElementById('riasecChart');
      if (window.myChart) window.myChart.destroy(); // √âvite les conflits
      window.myChart = new Chart(ctx, config);
    }

    // =================================================================================
    // G√âN√âRATION DU RAPPORT D'ANALYSE
    // =================================================================================
    /**
     * G√©n√®re un r√©sum√© d√©taill√© de l'analyse RIASEC pour chaque √©chelle
     * @param {object[]} entries - Tableau d'objets contenant les r√©sultats d'analyse
     * @returns {string} Rapport format√© avec tous les indicateurs
     */
    function buildSummary(entries) {
      return entries.map((e,i) => {
        // Convertit les classes en niveaux de diff√©rentiation lisibles
        const diffLevelH = differentiationLevelFromClass(e.class.homme);
        const diffLevelF = differentiationLevelFromClass(e.class.femme);

        // Interpr√®te les dimensions de Prediger
        const things_label = e.pred.things_people > 0 ? '<strong>Objets</strong>' :
                           (e.pred.things_people < 0 ? '<strong>Personnes</strong>' : '<strong>Neutre</strong>');
        const ideas_label = e.pred.ideas_data > 0 ? '<strong>Id√©es</strong>' :
                          (e.pred.ideas_data < 0 ? '<strong>Faits</strong>' : '<strong>Neutre</strong>');

        // Formatage du r√©sum√© harmonis√© pour une √©chelle
        return `${i+1}. <strong>${e.name}</strong><br>` +
               `   Profil : <strong>${e.top[0]}${e.top[1]}</strong> ‚Üí <strong>Consistance ${e.consistance}</strong><br>` +
               `   Diff√©rentiation : <strong>${diffLevelH}</strong> (H) / <strong>${diffLevelF}</strong> (F) ‚Ä¢ D=${e.D}<br>` +
               `   Prediger : ${things_label} / ${ideas_label}`;
      }).join('<br><br>');
    }

    // =================================================================================
    // TRAITEMENT PRINCIPAL - ANALYSE ET VISUALISATION
    // =================================================================================
    /**
     * Gestionnaire d'√©v√©nement pour le bouton "Afficher le graphique"
     * Orchestre toute l'analyse RIASEC et la visualisation des r√©sultats
     */
    document.getElementById('plotBtn').addEventListener('click', ()=> {
      // √âtape 1: S√©lectionne les √©chelles coch√©es par l'utilisateur
      const selected = scales.filter(s=>s.selected);
      if (selected.length === 0) {
        alert('S√©lectionne au moins une √©chelle √† afficher.');
        return;
      }

      // √âtape 2: Validation des donn√©es saisies
      for (let s of selected) {
        if (!validateScale(s)) {
          // Met en surbrillance les champs invalides
          LABELS.forEach((L,i)=> {
            const input = document.getElementById(`val-${s.id}-${L}`);
            const v = parseFloat(s.values[i]);
            if (s.values[i] === '' || isNaN(v) || v < 0 || v > s.max) {
              input.classList.add('invalid');
            }
          });
          alert(`√âchelle "${s.name}" contient des valeurs invalides. Corrige les champs en rouge.`);
          return;
        }
      }

      // √âtape 3: Pr√©paration des donn√©es pour l'analyse
      const datasets = [], labelsForDatasets = [], summaries = [];

      selected.forEach((s, idx) => {
        // Normalise les scores pour le graphique (√©chelle 0-5)
        const norm = s.values.map(v => normalizeForChart(parseFloat(v), s.max));
        datasets.push(norm);
        labelsForDatasets.push(`${s.name} (max ${s.max})`);

        // Analyse compl√®te du profil RIASEC
        const top = getTopTwoTypes(norm);                    // Types dominants
        const cons = evaluateConsistance(top[0], top[1]);    // Coh√©rence entre types
        const D = computeDifferentiationIndex_on100(s.values, s.max);  // Diff√©rentiation
        const cls = classifyDifferentiation(D);             // Classification H/F
        const pred = computePredigerOn100(s.values, s.max); // Dimensions de Prediger

        // Stockage des r√©sultats pour le r√©sum√©
        summaries.push({ name: s.name, top, consistance: cons, D, class: cls, pred });
      });

      // √âtape 4: Calcul du coefficient de concordance de Kendall W
      const kendallW = computeKendallW(selected);

      // √âtape 5: Visualisation et rapport
      renderChart(datasets, labelsForDatasets);           // Cr√©e le graphique

      // G√©n√®re le r√©sum√© avec l'analyse Kendall W
      let fullSummary = buildSummary(summaries);

      // Ajoute l'analyse de concordance si disponible
      if (selected.length >= 2) {
        // Extrait seulement le niveau de concordance (avant le premier tiret)
        const concordanceLevel = kendallW.interpretation.split(' - ')[0];
        fullSummary = `CONCORDANCE : W=${kendallW.W}, œá¬≤=${kendallW.chi2} (df=${kendallW.df}), p‚âà${kendallW.p ? kendallW.p.toFixed(3) : 'N/A'} ‚Üí <strong>${concordanceLevel}</strong><br><br>` + fullSummary;
      }

      document.getElementById('summary').innerHTML = fullSummary;  // Affiche le r√©sum√©
    });

    // =================================================================================
    // FONCTIONS UTILITAIRES ET GESTION DE L'√âTAT
    // =================================================================================
    /**
     * Nettoie l'affichage quand aucune √©chelle n'est s√©lectionn√©e
     * Supprime le graphique et efface le r√©sum√© pour √©viter la confusion
     */
    function updateEmptyIfNeeded() {
      const anySelected = scales.some(s=>s.selected);
      if (!anySelected) {
        // D√©truit le graphique s'il existe
        if (window.myChart) {
          window.myChart.destroy();
          window.myChart = null;
        }
        // Efface le r√©sum√©
        document.getElementById('summary').innerHTML = '';
      }
    }

    /**
     * √âchappe les caract√®res HTML pour √©viter les injections XSS
     * @param {string} str - Cha√Æne √† √©chapper
     * @returns {string} Cha√Æne avec caract√®res HTML √©chapp√©s
     */
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m)=> ({
        '&':'&',
        '<':'<',
        '>':'>',
        '"':'"',
        "'":'&#39;'
      })[m]);
    }

    // =================================================================================
    // RED√âCLARATIONS POUR COMPATIBILIT√â (HOISTING)
    // =================================================================================
    /**
     * Red√©claration de validateScale pour s'assurer qu'elle existe
     * lors de la cr√©ation des event listeners (histoire de hoisting)
     * @param {object} s - Objet √©chelle √† valider
     * @returns {boolean} true si tous les scores sont valides
     */
    function validateScale(s) {
      for (let i=0;i<6;i++) {
        const raw = s.values[i];
        const v = parseFloat(raw);
        if (raw === '' || isNaN(v) || v < 0 || v > s.max) return false;
      }
      return true;
    }

    // =================================================================================
    // FONCTIONS DE SAUVEGARDE ET DE R√âCUP√âRATION RIASEC
    // =================================================================================

    // Configuration Supabase (√† remplacer par vos vraies cl√©s)
    const SUPABASE_CONFIG = {
        url: 'https://oefhvkvvvikccrpgpsjk.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lZmh2a3Z2dmlrY2NycGdwc2prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDExODcsImV4cCI6MjA3NjE3NzE4N30.quWFAnfQoBeYo0sHG6dXYps1UzbyGA-3LkMk0sR0d8Q'
    };

    let supabaseClient = null;

    function initializeSupabase() {
        if (typeof supabase === 'undefined') {
            console.error('Supabase library not loaded. Please include the Supabase CDN script.');
            return false;
        }

        try {
            supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            console.log('Supabase client initialized successfully');
            return true;
        } catch (error) {
            console.error('Error initializing Supabase:', error);
            return false;
        }
    }

    function generateUniquePassword() {
        const timestamp = Date.now().toString(36);
        const randomStr = Math.random().toString(36).substring(2, 8);
        return (timestamp + randomStr).toUpperCase();
    }

    // Sauvegarder la session actuelle
    async function saveCurrentSession() {
        if (scales.length === 0) {
            alert('Aucune √©chelle √† sauvegarder.');
            return;
        }

        const sessionName = prompt('Nom de cette session RIASEC :', `Session RIASEC ${new Date().toLocaleDateString('fr-FR')}`);
        if (!sessionName) return;

        try {
            if (!supabaseClient && !initializeSupabase()) {
                throw new Error('Impossible d\'initialiser la connexion √† la base de donn√©es');
            }

            const password = generateUniquePassword();
            const sessionData = {
                name: sessionName,
                scales: scales.map(s => ({
                    name: s.name,
                    max: s.max,
                    values: s.values,
                    selected: s.selected
                })),
                scales_count: scales.length,
                selected_scales_count: scales.filter(s => s.selected).length,
                created_at: new Date().toISOString()
            };

            const { data, error } = await supabaseClient
                .from('riasec_sessions')
                .insert([{
                    name: sessionName,
                    password: password,
                    scales_data: sessionData,
                    scales_count: scales.length,
                    selected_scales_count: scales.filter(s => s.selected).length,
                    created_at: new Date().toISOString(),
                    version: '1.0'
                }])
                .select()
                .single();

            if (error) throw error;

            // Cr√©er une interface personnalis√©e pour le succ√®s
            showSuccessDialog(sessionName, password, scales.length);
            console.log('Session sauvegard√©e:', data.id);

        } catch (error) {
            console.error('Erreur lors de la sauvegarde:', error);
            alert(`‚ùå Erreur lors de la sauvegarde: ${error.message}\n\nV√©rifiez votre configuration Supabase dans le code.`);
        }
    }

    // R√©cup√©rer une session par mot de passe (ou mode admin avec 'coP1')
    async function loadSessionFromPassword() {
        const password = prompt('Entrez le mot de passe de la session:');
        if (!password || password.length < 2) {
            alert('Le mot de passe doit contenir au moins 2 caract√®res.');
            return;
        }

        try {
            if (!supabaseClient && !initializeSupabase()) {
                throw new Error('Impossible d\'initialiser la connexion √† la base de donn√©es');
            }

            // Mode administrateur avec le mot de passe 'coP1'
            if (password.toLowerCase() === 'cop1') {
                await loadAdminMode();
                return;
            }

            // Mode normal : r√©cup√©ration par mot de passe unique
            const { data, error } = await supabaseClient
                .from('riasec_sessions')
                .select('*')
                .eq('password', password)
                .single();

            if (error) {
                if (error.code === 'PGRST116') {
                    alert('Aucune session trouv√©e avec ce mot de passe.');
                } else {
                    throw error;
                }
                return;
            }

            // Restaurer les √©chelles depuis les donn√©es sauvegard√©es
            restoreSession(data);

        } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration:', error);
            alert(`‚ùå Erreur lors de la r√©cup√©ration: ${error.message}`);
        }
    }

    // Restaurer une session depuis les donn√©es sauvegard√©es
    function restoreSession(sessionData) {
        try {
            // Vider les √©chelles actuelles
            scales = [];
            scaleIdCounter = 0;
            document.getElementById('scalesContainer').innerHTML = '';
            document.getElementById('summary').innerHTML = '';

            if (window.myChart) {
                window.myChart.destroy();
                window.myChart = null;
            }

            // Recr√©er les √©chelles depuis les donn√©es sauvegard√©es
            if (sessionData.scales_data && sessionData.scales_data.scales) {
                sessionData.scales_data.scales.forEach(scaleData => {
                    addScale(scaleData.name, scaleData.max, scaleData.values);
                    const newScale = scales[scales.length - 1];
                    newScale.selected = scaleData.selected;
                    const checkbox = document.getElementById(`select-${newScale.id}`);
                    if (checkbox) checkbox.checked = scaleData.selected;
                });
            }

            alert(`‚úÖ Session "${sessionData.name}" restaur√©e avec succ√®s!\n` +
                  `üìÖ Cr√©√©e le: ${new Date(sessionData.created_at).toLocaleDateString('fr-FR')}\n` +
                  `üìä √âchelles: ${sessionData.scales_count}`);

        } catch (error) {
            console.error('Erreur lors de la restauration:', error);
            alert(`‚ùå Erreur lors de la restauration: ${error.message}`);
        }
    }

    // Mode administrateur : interface graphique pour choisir les sessions
    async function loadAdminMode() {
        try {
            if (!supabaseClient && !initializeSupabase()) {
                throw new Error('Impossible d\'initialiser la connexion √† la base de donn√©es');
            }

            const { data, error } = await supabaseClient
                .from('riasec_sessions')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            if (data.length === 0) {
                alert('üîê MODE ADMINISTRATEUR\n\nAucune session trouv√©e dans la base de donn√©es.');
                return;
            }

            // Cr√©er une interface graphique pour s√©lectionner les sessions
            await showAdminSessionSelector(data);

        } catch (error) {
            console.error('Erreur en mode administrateur:', error);
            alert(`‚ùå Erreur en mode administrateur: ${error.message}`);
        }
    }

    // Afficher l'interface graphique de s√©lection des sessions
    async function showAdminSessionSelector(sessions) {
        return new Promise((resolve) => {
            // Cr√©er la fen√™tre modale
            const modal = document.createElement('div');
            modal.id = 'adminModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: Arial, sans-serif;
            `;

            // Cr√©er le contenu de la fen√™tre
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 25px;
                max-width: 90%;
                max-height: 80%;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;

            // En-t√™te
            const header = document.createElement('h2');
            header.textContent = 'üîê MODE ADMINISTRATEUR - S√©lectionnez une session';
            header.style.cssText = `
                margin: 0 0 20px 0;
                color: #2c3e50;
                text-align: center;
                border-bottom: 2px solid #667eea;
                padding-bottom: 15px;
            `;

            // Liste des sessions
            const sessionsList = document.createElement('div');
            sessionsList.style.cssText = `
                display: grid;
                gap: 15px;
                margin-bottom: 20px;
            `;

            // Cr√©er un bouton pour chaque session
            sessions.forEach((session, index) => {
                const sessionButton = document.createElement('button');
                sessionButton.className = 'session-button';

                const date = new Date(session.created_at).toLocaleDateString('fr-FR');
                const time = new Date(session.created_at).toLocaleTimeString('fr-FR');

                sessionButton.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div style="text-align: left;">
                            <div style="font-weight: bold; font-size: 1.1em; color: #2c3e50;">${session.name}</div>
                            <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">
                                üìÖ ${date} ${time} | üìä ${session.scales_count} √©chelles
                            </div>
                            <div style="font-size: 0.8em; color: #888; margin-top: 3px; font-family: monospace;">
                                üîë ${session.password}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: #667eea; font-size: 1.2em;">
                            #${index + 1}
                        </div>
                    </div>
                `;

                sessionButton.style.cssText = `
                    width: 100%;
                    padding: 15px;
                    border: 2px solid #e1e8ed;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                    cursor: pointer;
                    text-align: left;
                    transition: all 0.3s ease;
                    font-size: 0.9em;
                `;

                sessionButton.onmouseover = () => {
                    sessionButton.style.borderColor = '#667eea';
                    sessionButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    sessionButton.style.color = 'white';
                    sessionButton.querySelector('div').style.color = 'white';
                };

                sessionButton.onmouseout = () => {
                    sessionButton.style.borderColor = '#e1e8ed';
                    sessionButton.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%)';
                    sessionButton.style.color = 'inherit';
                    sessionButton.querySelector('div').style.color = '';
                };

                sessionButton.onclick = () => {
                    document.body.removeChild(modal);
                    console.log('Session s√©lectionn√©e:', session);
                    restoreSession(session);
                    resolve();
                };

                sessionsList.appendChild(sessionButton);
            });

            // Bouton annuler
            const cancelButton = document.createElement('button');
            cancelButton.textContent = '‚ùå Annuler';
            cancelButton.style.cssText = `
                background: #dc3545;
                color: white;
                border: none;
                padding: 12px 25px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1em;
                font-weight: bold;
                width: 100%;
                margin-top: 15px;
            `;

            cancelButton.onclick = () => {
                document.body.removeChild(modal);
                resolve();
            };

            // Assembler la fen√™tre
            modalContent.appendChild(header);
            modalContent.appendChild(sessionsList);
            modalContent.appendChild(cancelButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Fermer en cliquant en dehors
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    resolve();
                }
            };
        });
    }

    // Lister les sessions disponibles (pour s√©lection)
    async function listAvailableSessions() {
        try {
            if (!supabaseClient && !initializeSupabase()) {
                throw new Error('Impossible d\'initialiser la connexion √† la base de donn√©es');
            }

            const { data, error } = await supabaseClient
                .from('riasec_sessions')
                .select('id, name, created_at, scales_count, selected_scales_count')
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) throw error;

            if (data.length === 0) {
                alert('Aucune session trouv√©e dans la base de donn√©es.');
                return;
            }

            // Cr√©er une liste des sessions disponibles
            const sessionList = data.map((session, index) =>
                `${index + 1}. ${session.name}\n` +
                `   Cr√©√©e le: ${new Date(session.created_at).toLocaleDateString('fr-FR')}\n` +
                `   √âchelles: ${session.scales_count}`
            ).join('\n\n');

            alert(`üìã Sessions disponibles:\n\n${sessionList}\n\nüí° Utilisez le mot de passe unique pour charger une session sp√©cifique.`);

        } catch (error) {
            console.error('Erreur lors de la liste des sessions:', error);
            alert(`‚ùå Erreur lors de la r√©cup√©ration des sessions: ${error.message}`);
        }
    }

    // Afficher le dialogue de succ√®s personnalis√©
    function showSuccessDialog(sessionName, password, scalesCount) {
        // Cr√©er la fen√™tre modale
        const modal = document.createElement('div');
        modal.id = 'successModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: Arial, sans-serif;
        `;

        // Cr√©er le contenu de la fen√™tre
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
        `;

        // Ic√¥ne de succ√®s
        const icon = document.createElement('div');
        icon.textContent = '‚úÖ';
        icon.style.cssText = `
            font-size: 4em;
            margin-bottom: 20px;
        `;

        // Titre
        const title = document.createElement('h2');
        title.textContent = 'Session sauvegard√©e avec succ√®s!';
        title.style.cssText = `
            margin: 0 0 20px 0;
            color: #28a745;
            font-size: 1.5em;
        `;

        // Informations de la session
        const info = document.createElement('div');
        info.style.cssText = `
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            border-left: 4px solid #28a745;
        `;

        info.innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>üìã Nom:</strong> <span style="color: #495057;">${sessionName}</span>
            </div>
            <div style="margin-bottom: 10px;">
                <strong>üîë Mot de passe:</strong>
                <span style="color: #495057; font-family: monospace; font-size: 1.1em;">${password}</span>
            </div>
            <div style="margin-bottom: 10px;">
                <strong>üìä √âchelles:</strong> <span style="color: #495057;">${scalesCount}</span>
            </div>
        `;

        // Bouton copier le mot de passe
        const copyButton = document.createElement('button');
        copyButton.textContent = 'üìã Copier le mot de passe';
        copyButton.style.cssText = `
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 10px;
            transition: transform 0.2s ease;
        `;

        copyButton.onmouseover = () => {
            copyButton.style.transform = 'translateY(-2px)';
        };

        copyButton.onmouseout = () => {
            copyButton.style.transform = 'translateY(0)';
        };

        copyButton.onclick = async () => {
            try {
                await navigator.clipboard.writeText(password);
                copyButton.textContent = '‚úÖ Copi√©!';
                copyButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                setTimeout(() => {
                    copyButton.textContent = 'üìã Copier le mot de passe';
                    copyButton.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
                }, 2000);
            } catch (err) {
                // Fallback pour les navigateurs qui ne supportent pas clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = password;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                copyButton.textContent = '‚úÖ Copi√©!';
                copyButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                setTimeout(() => {
                    copyButton.textContent = 'üìã Copier le mot de passe';
                    copyButton.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
                }, 2000);
            }
        };

        // Bouton OK
        const okButton = document.createElement('button');
        okButton.textContent = 'OK';
        okButton.style.cssText = `
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 10px;
        `;

        okButton.onclick = () => {
            document.body.removeChild(modal);
        };

        // Conteneur des boutons
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        `;
        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(okButton);

        // Message d'aide
        const helpText = document.createElement('div');
        helpText.innerHTML = `
            <div style="margin-top: 20px; font-size: 0.9em; color: #6c757d;">
                üí° <strong>Notez ce mot de passe</strong> pour r√©cup√©rer la session plus tard.
            </div>
        `;

        // Assembler la fen√™tre
        modalContent.appendChild(icon);
        modalContent.appendChild(title);
        modalContent.appendChild(info);
        modalContent.appendChild(helpText);
        modalContent.appendChild(buttonContainer);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Fermer en cliquant en dehors
        modal.onclick = (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        };
    }

    // Event listeners pour les boutons de sauvegarde/chargement
    document.getElementById('saveBtn').addEventListener('click', saveCurrentSession);
    document.getElementById('loadBtn').addEventListener('click', loadSessionFromPassword);
  </script>
</body>
</html>
```
